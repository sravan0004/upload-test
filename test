using System.Data;
using System.Data.Common;
using Microsoft.EntityFrameworkCore;

public class SpecimenProcessor
{
    private readonly YourDbContext _db;

    public SpecimenProcessor(YourDbContext db)
    {
        _db = db;
    }

    // ------------------------------
    // Helper: execute stored procedure (no result set)
    // ------------------------------
    private async Task ExecuteSpAsync(string spName, string processId, DbConnection conn)
    {
        await using var cmd = conn.CreateCommand();
        cmd.CommandText = spName;
        cmd.CommandType = CommandType.StoredProcedure;

        var p = cmd.CreateParameter();
        p.ParameterName = "mPROCESS_ID";
        p.Value = processId;
        cmd.Parameters.Add(p);

        await cmd.ExecuteNonQueryAsync();
    }

    // ------------------------------
    // Helper: execute scalar
    // ------------------------------
    private async Task<object?> ExecuteScalarAsync(string sql, string processId, DbConnection conn)
    {
        await using var cmd = conn.CreateCommand();
        cmd.CommandText = sql;
        cmd.CommandType = CommandType.Text;

        var p = cmd.CreateParameter();
        p.ParameterName = "@p";
        p.Value = processId;
        cmd.Parameters.Add(p);

        return await cmd.ExecuteScalarAsync();
    }

    // ------------------------------
    // Helper: execute reader & return list of error messages
    // ------------------------------
    private async Task<List<string>> LoadErrorsAsync(string processId, DbConnection conn)
    {
        var output = new List<string>();

        await using var cmd = conn.CreateCommand();
        cmd.CommandText =
            @"SELECT CONCAT('Row# ', row_no, ' ', TRIM(ERROR_MSG)) AS MSG
              FROM stage_specimen
              WHERE ERROR_MSG IS NOT NULL AND PROCESS_ID = @p";
        cmd.CommandType = CommandType.Text;

        var p = cmd.CreateParameter();
        p.ParameterName = "@p";
        p.Value = processId;
        cmd.Parameters.Add(p);

        await using var reader = await cmd.ExecuteReaderAsync();
        while (await reader.ReadAsync())
            output.Add(reader.GetString(0));

        return output;
    }

    // ------------------------------
    // Public Method: Validate + Insert
    // ------------------------------
    public async Task<object> ProcessSpecimenAsync(string processId)
    {
        var conn = _db.Database.GetDbConnection();

        if (conn.State != ConnectionState.Open)
            await conn.OpenAsync();

        // Run SP1–SP4 in parallel
        var t1 = ExecuteSpAsync("sp_specimen_validate_studytype", processId, conn);
        var t2 = ExecuteSpAsync("sp_specimen_validate_volumes", processId, conn);
        var t3 = ExecuteSpAsync("sp_specimen_validate_duplicates", processId, conn);
        var t4 = ExecuteSpAsync("sp_specimen_validate_misc", processId, conn);

        await Task.WhenAll(t1, t2, t3, t4);

        // Check total error count
        var errorCountObj = await ExecuteScalarAsync(
            "SELECT COUNT(*) FROM stage_specimen WHERE ERROR_MSG IS NOT NULL AND PROCESS_ID = @p",
            processId,
            conn);

        int errorCount = Convert.ToInt32(errorCountObj);

        // If validation failed → return errors
        if (errorCount > 0)
        {
            var errors = await LoadErrorsAsync(processId, conn);

            return new
            {
                RECORD_CNT = 0,
                SUCCESS_MSG = (string?)null,
                ERRORS = errors
            };
        }

        // Validation passed → call SP5 (insert)
        var finalResult = new List<object>();

        await using (var cmd = conn.CreateCommand())
        {
            cmd.CommandText = "sp_specimen_insert_records";
            cmd.CommandType = CommandType.StoredProcedure;

            var p = cmd.CreateParameter();
            p.ParameterName = "mPROCESS_ID";
            p.Value = processId;
            cmd.Parameters.Add(p);

            await using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                finalResult.Add(new
                {
                    MSG = reader["MSG"]?.ToString(),
                    RECORD_CNT = reader["RECORD_CNT"],
                    SUCCESS_MSG = reader["SUCCESS_MSG"]
                });
            }
        }

        return finalResult;
    }
}
