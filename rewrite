using var transaction = _context.Database.BeginTransaction();
    try
    {
        foreach (var specimen in specimens)
        {
            var dbResult = SaveOrUpdateSpecimen(specimen);

            if (!string.Equals(dbResult, "OK", StringComparison.OrdinalIgnoreCase))
            {
                // Rollback and return error
                transaction.Rollback();
                TempData["Errors"] = $"Row with SpecimenIdentifier {specimen.SpecimenIdentifier}: DB error - {dbResult}";
                TempData["ErrorCount"] = 1;
                return RedirectToAction("Index");
            }
        }

        transaction.Commit();
        ViewBag.SuccessMessage = $"{specimens.Count} records processed and saved.";
        return View("Index");
    }
    catch (Exception ex)
    {
        transaction.Rollback();
        TempData["Errors"] = $"Transaction failed: {ex.Message}";
        TempData["ErrorCount"] = 1;
        return RedirectToAction("Index");
    }
