using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Dynamic;
using System.Linq;
using System.Threading.Tasks;
using System.Linq.Dynamic.Core;
using ACATWebAPI.Data.Models;

namespace ACATWebAPI.Data.Helpers
{
    public static class KendoGridHelper
    {
        public static async Task<object> ApplyServerSideOperationsAsync<T>(
            object dataSource,
            KendoGridRequest request)
        {
            IQueryable<dynamic> queryable = ConvertToQueryable(dataSource);

            var total = queryable.Count();

            // Sorting
            if (request.Sort != null && request.Sort.Any())
            {
                var sortString = string.Join(",", request.Sort.Select(s => $"{s.Field} {s.Dir}"));
                queryable = queryable.OrderBy(sortString);
            }

            // Grouping (Dynamic LINQ fix)
            if (request.Group != null && request.Group.Any())
            {
                var grouped = ApplyGrouping(queryable, request.Group);
                return new { data = grouped, total };
            }

            // Paging
            if (request.Skip > 0)
                queryable = queryable.Skip(request.Skip);
            if (request.Take > 0)
                queryable = queryable.Take(request.Take);

            // Execution (handles async vs sync)
            var data = (dataSource is IQueryable<T>)
                ? await Task.Run(() => queryable.ToDynamicList())
                : queryable.ToDynamicList();

            return new { data, total };
        }

        private static IQueryable<dynamic> ConvertToQueryable(object source)
        {
            return source switch
            {
                IQueryable q => q.Cast<dynamic>(),
                IEnumerable<object> list => list.AsQueryable().Cast<dynamic>(),
                DataTable dt => dt.AsEnumerable().Select(ToExpando).AsQueryable(),
                _ => throw new InvalidOperationException("Unsupported data source type")
            };
        }

        private static ExpandoObject ToExpando(DataRow row)
        {
            var expando = new ExpandoObject() as IDictionary<string, object?>;
            foreach (DataColumn col in row.Table.Columns)
                expando[col.ColumnName] = row[col] == DBNull.Value ? null : row[col];
            return (ExpandoObject)expando;
        }

        /// <summary>
        /// Fixed version of ApplyGrouping â€” supports multiple group levels
        /// and uses correct Dynamic LINQ syntax with 'as' clause
        /// </summary>
        private static List<object> ApplyGrouping(IQueryable<dynamic> query, IEnumerable<KendoGroupDescriptor> groups)
        {
            // Build valid dynamic group expression: new(Field1 as Field1, Field2 as Field2)
            var groupFields = string.Join(", ", groups.Select(g => $"{g.Field} as {g.Field}"));
            var groupExpr = $"new({groupFields})";

            // Dynamic LINQ grouping
            var grouped = query.GroupBy(groupExpr, "it")
                               .Select("new (Key as Key, it as Items)")
                               .ToDynamicList();

            var result = new List<object>();
            foreach (dynamic g in grouped)
            {
                var items = ((IEnumerable<dynamic>)g.Items).ToList();

                result.Add(new
                {
                    field = groups.First().Field,
                    value = g.Key,
                    items,
                    hasSubgroups = groups.Count() > 1
                });
            }

            return result;
        }
    }

    /// <summary>
    /// Maps UI grid parameters to KendoGridRequest
    /// </summary>
    public static class KendoGridMapper
    {
        public static KendoGridRequest ToKendoGridRequest(this PageSettings ui)
        {
            return new KendoGridRequest
            {
                Skip = ui.Skip,
                Take = ui.Take,
                Group = ui.Group?.Select(g => new KendoGroupDescriptor
                {
                    Field = g.Field
                }).ToList(),
                Sort = ui.Sorts?.Select(s => new KendoSortDescriptor
                {
                    Field = s.Field,
                    Dir = s.Dir
                }).ToList(),
                Filter = ui.Filters != null
                    ? new List<KendoFilterDescriptor>
                    {
                        new KendoFilterDescriptor
                        {
                            Logic = ui.Filters.Logic,
                            Filters = ui.Filters.Filters?.Select(f => new KendoFilterItem
                            {
                                Field = f.Field,
                                Operator = f.Operator,
                                Value = f.Value
                            }).ToList()
                        }
                    }
                    : null
            };
        }
    }
}
namespace ACATWebAPI.Data.Models
{
    public class KendoGridRequest
    {
        public int Skip { get; set; }
        public int Take { get; set; }
        public IEnumerable<KendoSortDescriptor>? Sort { get; set; }
        public IEnumerable<KendoFilterDescriptor>? Filter { get; set; }
        public IEnumerable<KendoGroupDescriptor>? Group { get; set; }
    }

    public class KendoSortDescriptor
    {
        public string Field { get; set; } = string.Empty;
        public string Dir { get; set; } = "asc";
    }

    public class KendoFilterDescriptor
    {
        public string? Logic { get; set; }
        public IEnumerable<KendoFilterItem>? Filters { get; set; }
    }

    public class KendoGroupDescriptor
    {
        public string Field { get; set; } = string.Empty;
    }

    public class KendoFilterItem
    {
        public string Field { get; set; } = string.Empty;
        public string Operator { get; set; } = string.Empty;
        public object? Value { get; set; }
    }

    public class DataSourceResult
    {
        public object? Data { get; set; }
        public int Total { get; set; }
    }

    public class KendoAggregateDescriptor
    {
        public string Field { get; set; } = string.Empty;
        public string Aggregate { get; set; } = string.Empty;
    }
}
