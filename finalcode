using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Dynamic;
using System.Linq;
using System.Linq.Dynamic.Core;
using System.Threading.Tasks;

public static class KendoGridHelper
{
    public static async Task<object> ApplyServerSideOperationsAsync<T>(
        object dataSource,
        KendoGridRequest request)
    {
        IQueryable<dynamic> queryable = ConvertToQueryable(dataSource);

        // ✅ 1. Apply filtering first
        if (request.Filter != null && request.Filter.Any())
        {
            queryable = ApplyFiltering(queryable, request.Filter);
        }

        var total = queryable.Count();

        // ✅ 2. Apply sorting
        if (request.Sort != null && request.Sort.Any())
        {
            var sortString = string.Join(",", request.Sort.Select(s => $"{s.Field} {s.Dir}"));
            queryable = queryable.OrderBy(sortString);
        }

        // ✅ 3. Materialize before grouping
        var list = await Task.Run(() => queryable.ToDynamicList());

        // ✅ 4. Apply grouping (in-memory)
        if (request.Group != null && request.Group.Any())
        {
            var grouped = ApplyGrouping(list.AsQueryable(), request.Group);
            return new { data = grouped, total };
        }

        // ✅ 5. Paging
        var paged = list.Skip(request.Skip).Take(request.Take);

        return new { data = paged, total };
    }

    // -- Filtering --
    private static IQueryable<dynamic> ApplyFiltering(IQueryable<dynamic> query, IEnumerable<KendoFilterDescriptor> filters)
    {
        var allPredicates = new List<string>();
        var allValues = new List<object>();

        foreach (var descriptor in filters)
        {
            if (descriptor.Filters == null) continue;

            var (predicate, values) = BuildFilterPredicate(descriptor);
            if (!string.IsNullOrWhiteSpace(predicate))
            {
                allPredicates.Add(predicate);
                allValues.AddRange(values);
            }
        }

        if (!allPredicates.Any())
            return query;

        var whereClause = string.Join(" and ", allPredicates);
        return query.Where(whereClause, allValues.ToArray());
    }

    private static (string Predicate, List<object> Values) BuildFilterPredicate(KendoFilterDescriptor descriptor)
    {
        var parts = new List<string>();
        var values = new List<object>();

        if (descriptor.Filters == null)
            return ("", values);

        foreach (var f in descriptor.Filters)
        {
            var idx = values.Count;
            string part = f.Operator switch
            {
                "eq" => $"{f.Field} == @{idx}",
                "neq" => $"{f.Field} != @{idx}",
                "gt" => $"{f.Field} > @{idx}",
                "gte" => $"{f.Field} >= @{idx}",
                "lt" => $"{f.Field} < @{idx}",
                "lte" => $"{f.Field} <= @{idx}",
                "contains" => $"{f.Field}.ToString().Contains(@{idx})",
                "doesnotcontain" => $"!{f.Field}.ToString().Contains(@{idx})",
                "startswith" => $"{f.Field}.ToString().StartsWith(@{idx})",
                "endswith" => $"{f.Field}.ToString().EndsWith(@{idx})",
                _ => $"{f.Field} == @{idx}"
            };

            parts.Add(part);
            values.Add(f.Value ?? "");
        }

        var logic = string.IsNullOrEmpty(descriptor.Logic) ? "and" : descriptor.Logic;
        var predicate = string.Join($" {logic} ", parts);

        return (predicate, values);
    }

    // -- Grouping (unchanged) --
    private static List<object> ApplyGrouping(IQueryable<dynamic> query, IEnumerable<KendoGroupDescriptor> groups)
    {
        if (groups == null || !groups.Any())
            return query.ToDynamicList<object>();

        var first = groups.First();
        var grouped = query.AsEnumerable()
            .GroupBy(x => GetPropValue(x, first.Field))
            .Select(g => new
            {
                field = first.Field,
                value = g.Key,
                items = groups.Count() > 1
                    ? ApplyGrouping(g.AsQueryable(), groups.Skip(1))
                    : g.ToList()
            }).ToList<object>();

        return grouped;
    }

    private static object? GetPropValue(object obj, string propName)
    {
        if (obj == null || string.IsNullOrEmpty(propName))
            return null;

        if (obj is IDictionary<string, object> dict)
        {
            dict.TryGetValue(propName, out var value);
            return value;
        }

        var prop = obj.GetType().GetProperty(propName);
        return prop?.GetValue(obj, null);
    }

    // -- Helper for source conversion --
    private static IQueryable<dynamic> ConvertToQueryable(object source)
    {
        return source switch
        {
            IQueryable q => q.Cast<dynamic>(),
            IEnumerable<object> list => list.AsQueryable().Cast<dynamic>(),
            DataTable dt => dt.AsEnumerable().Select(ToExpando).AsQueryable(),
            _ => throw new InvalidOperationException("Unsupported data source type")
        };
    }

    private static ExpandoObject ToExpando(DataRow row)
    {
        var expando = new ExpandoObject() as IDictionary<string, object?>;
        foreach (DataColumn col in row.Table.Columns)
            expando[col.ColumnName] = row[col] == DBNull.Value ? null : row[col];
        return (ExpandoObject)expando;
    }
}
