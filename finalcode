namespace ACATWebAPI.Data.Helpers
{

    // Inspired from
    // https://github.com/andreavitali/NetCoreKendoGridBinding/blob/master/Kendo/KendoDataSourceResponse.cs
    // https://github.com/linmasaki/KendoNET.DynamicLinq/blob/master/src/QueryableExtensions.cs
    public static class KendoGridHelper
    {
        public static async Task<object> ApplyServerSideOperationsAsync<T>(
            object dataSource,
            KendoGridRequest request)
        {
            IQueryable<dynamic> queryable = ConvertToQueryable(dataSource);

            // Filtering
            //if (request.Filter != null)
            //{
            //    var whereClause = BuildWhereClause(request.Filter);
            //    if (!string.IsNullOrEmpty(whereClause))
            //        queryable = queryable.Where(whereClause);
            //}

            var total = queryable.Count();

            // Sorting
            if (request.Sort != null && request.Sort.Any())
            {
                var sortString = string.Join(",", request.Sort.Select(s => $"{s.Field} {s.Dir}"));
                queryable = queryable.OrderBy(sortString);
            }

            // Grouping
            if (request.Group != null && request.Group.Any())
            {
                var grouped = ApplyGrouping(queryable, request.Group);
                return new { data = grouped, total };
            }

            // Paging
            if (request.Skip > 0)
                queryable = queryable.Skip(request.Skip);
            if (request.Take > 0)
                queryable = queryable.Take(request.Take);

            // Handle async EF / sync List / DataTable
            var isAsync = dataSource is IQueryable<T>; // or DbSet<T>;
            var data = isAsync
                ? await Task.Run(() => queryable.ToDynamicList())
                : queryable.ToDynamicList();

            return new { data, total };
        }

        private static IQueryable<dynamic> ConvertToQueryable(object source)
        {
            return source switch
            {
                IQueryable q => q.Cast<dynamic>(),
                IEnumerable<object> list => list.AsQueryable().Cast<dynamic>(),
                DataTable dt => dt.AsEnumerable().Select(ToExpando).AsQueryable(),
                _ => throw new InvalidOperationException("Unsupported data source type")
            };
        }

        private static ExpandoObject ToExpando(DataRow row)
        {
            var expando = new ExpandoObject() as IDictionary<string, object?>;
            foreach (DataColumn col in row.Table.Columns)
            {
                expando[col.ColumnName] = row[col] == DBNull.Value ? null : row[col];
            }
            return (ExpandoObject)expando;
        }

        private static string? BuildWhereClause(IEnumerable<KendoFilterItem> filters)
        {
            if (filters == null || !filters.Any()) return null;

            var clauses = new List<string>();

            foreach (var filter in filters)
            {

                var op = filter.Operator switch
                {
                    "eq" => "==",
                    "neq" => "!=",
                    "contains" => ".ToString().Contains(@0)",
                    "startswith" => ".ToString().StartsWith(@0)",
                    "endswith" => ".ToString().EndsWith(@0)",
                    "lt" => "<",
                    "lte" => "<=",
                    "gt" => ">",
                    "gte" => ">=",
                    _ => "=="
                };

                if (op.Contains("("))
                    clauses.Add($"{filter.Field}{op}");
                else
                    clauses.Add($"{filter.Field} {op} @0");

            }

            var logic = "and";
            return string.Join($" {logic} ", clauses);
        }

        private static List<object> ApplyGrouping(IQueryable<dynamic> query, IEnumerable<KendoGroupDescriptor> groups)
        {
            var groupField = groups.First().Field;
            var grouped = query.GroupBy($"new({groupField})", "it")
                .Select($"new (Key.{groupField} as value, it as items)")
                .ToDynamicList();

            var result = new List<object>();
            foreach (dynamic g in grouped)
            {
                var items = ((IEnumerable<dynamic>)g.items).ToList();
                result.Add(new
                {
                    field = groupField,
                    value = g.value,
                    items,
                    hasSubgroups = false
                });
            }

            return result;
        }
    }

    public static class KendoGridMapper
    {
        public static KendoGridRequest ToKendoGridRequest(this PageSettings ui)
        {
            return new KendoGridRequest
            {
                Skip = ui.Skip,
                Take = ui.Take,
                Group = ui.Group?.Select(g => new KendoGroupDescriptor { Field = g.Field }).ToList(),
                Sort = ui.Sorts?.Select(s => new KendoSortDescriptor { Field = s.Field, Dir = s.Dir }).ToList(),
                Filter = ui.Filters != null ? new List<KendoFilterDescriptor>()
                {
                    new KendoFilterDescriptor()
                    {
                        Logic = ui.Filters.Logic,
                        Filters = ui.Filters?.Filters.Select(f => new KendoFilterItem
                        {
                            Field = f.Field,
                            Operator = f.Operator,
                            Value = f.Value,
                        }).ToList()
                    }

                } : null
            };
        }
    }
}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ACATWebAPI.Data.Models
{
    internal class KendoGridHelperModel
    {
    }
    public class KendoGridRequest
    {
        public int Skip { get; set; }
        public int Take { get; set; }
        public IEnumerable<KendoSortDescriptor>? Sort { get; set; }
        public IEnumerable<KendoFilterDescriptor>? Filter { get; set; }
        public IEnumerable<KendoGroupDescriptor>? Group { get; set; }
    }

    public class KendoSortDescriptor
    {
        public string Field { get; set; } = string.Empty;
        public string Dir { get; set; } = "asc";
    }

    public class KendoFilterDescriptor
    {
        public string? Logic { get; set; } // and/or
        public IEnumerable<KendoFilterItem>? Filters { get; set; }
    }

    public class KendoGroupDescriptor
    {
        public string Field { get; set; } = string.Empty;
        //public IEnumerable<KendoAggregateDescriptor>? Aggregates { get; set; }
    }

    public class KendoFilterItem
    {
        public string Field { get; set; } = string.Empty;
        public string Operator { get; set; } = string.Empty;
        public object? Value { get; set; }
    }

    public class DataSourceResult
    {
        public object? Data { get; set; }
        public int Total { get; set; }
    }

    public class KendoAggregateDescriptor
    {
        public string Field { get; set; } = string.Empty;
        public string Aggregate { get; set; } = string.Empty;
    }
}

